<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerChat - Group Voice & Text Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #7289da;
            --dark: #2c2f33;
            --darker: #23272a;
            --light: #ffffff;
            --gray: #99aab5;
            --success: #43b581;
            --danger: #f04747;
            --background: #36393f;
            --text-light: #b9bbbe;
            --hover: #3a3d45;
            --accent: #5865f2;
            --warning: #f1c40f;
        }

        body {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #1a1d21, #0f1114);
            color: var(--light);
            overflow: hidden;
        }

        /* Main container */
        .container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Left sidebar - Groups */
        .groups-sidebar {
            width: 80px;
            background-color: rgba(25, 27, 31, 0.9);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .group-icon {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .group-icon:hover {
            border-radius: 18px;
            transform: translateY(-3px);
        }

        .group-icon.active {
            border-radius: 18px;
            box-shadow: 0 0 0 3px var(--light);
        }

        .group-icon.add {
            background: rgba(255, 255, 255, 0.1);
            font-size: 24px;
        }

        .group-icon.add i {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* Channels sidebar */
        .channels-sidebar {
            width: 240px;
            background-color: rgba(30, 33, 36, 0.85);
            display: flex;
            flex-direction: column;
            color: var(--text-light);
            border-right: 1px solid rgba(0,0,0,0.2);
        }

        .channel-header {
            padding: 18px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.2);
        }

        .channel-header i {
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .channel-header i:hover {
            color: var(--primary);
            transform: rotate(15deg);
        }

        .channel-category {
            padding: 12px 16px;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            letter-spacing: 1px;
        }

        .channel-category i {
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-category i:hover {
            color: var(--primary);
        }

        .channel-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .channel {
            padding: 10px 16px;
            margin: 0 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .channel:hover {
            background-color: var(--hover);
            color: white;
            transform: translateX(5px);
        }

        .channel.active {
            background-color: rgba(88, 101, 242, 0.3);
            color: white;
        }

        .channel i {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .channel .user-count {
            margin-left: auto;
            background: var(--darker);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
        }

        /* Main chat area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            background: rgba(0,0,0,0.2);
            z-index: 10;
        }

        .chat-header i {
            color: var(--text-light);
            font-size: 20px;
        }

        .chat-header h2 {
            font-weight: 500;
            font-size: 18px;
        }

        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: url('https://www.transparenttextures.com/patterns/dark-geometric.png');
        }

        .message {
            display: flex;
            gap: 16px;
            animation: fadeIn 0.4s ease-out;
        }

        .avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 70%;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .username {
            font-weight: 600;
            color: white;
            font-size: 16px;
        }

        .timestamp {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .message-text {
            line-height: 1.5;
            color: #dcddde;
            font-size: 15px;
        }

        .gif-message {
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .gif-message img {
            width: 100%;
            display: block;
            border-radius: 6px;
        }

        .system-message {
            color: var(--text-light);
            font-size: 0.9rem;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            font-style: italic;
        }

        .voice-activity {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: rgba(59, 165, 92, 0.1);
            border-radius: 6px;
            margin-top: 5px;
            font-size: 14px;
        }

        .voice-activity i {
            color: var(--success);
        }

        /* Input area */
        .input-area {
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .message-input-container {
            background-color: rgba(0,0,0,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 18px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .message-input {
            width: 100%;
            padding: 14px 0;
            background: transparent;
            border: none;
            color: var(--light);
            font-size: 16px;
            outline: none;
        }

        .message-input-container i {
            color: var(--text-light);
            cursor: pointer;
            padding: 0 10px;
            transition: all 0.2s;
            font-size: 18px;
        }

        .message-input-container i:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        /* Voice controls */
        .voice-controls {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--darker);
            padding: 15px 30px;
            border-radius: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
            transition: all 0.4s ease;
            display: none;
        }

        .voice-controls.active {
            display: flex;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .voice-btn:hover {
            transform: scale(1.1);
        }

        .voice-btn.mute {
            background-color: var(--danger);
        }

        .voice-btn.mute.active {
            background-color: var(--success);
        }

        .voice-btn.leave {
            background-color: var(--danger);
        }

        .voice-status {
            background-color: var(--hover);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 200;
            background: rgba(0,0,0,0.6);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-connected {
            background-color: var(--success);
        }
        
        .status-connecting {
            background-color: var(--warning);
        }
        
        .status-disconnected {
            background-color: var(--danger);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--darker);
            padding: 30px;
            border-radius: 15px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-title {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--light);
            margin-bottom: 20px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
        }

        .modal-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.3);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            min-width: 120px;
        }

        .modal-btn.primary {
            background-color: var(--primary);
            color: white;
        }

        .modal-btn.primary:hover {
            background-color: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(88, 101, 242, 0.4);
        }

        .modal-btn.secondary {
            background-color: transparent;
            color: var(--text-light);
            border: 1px solid var(--text-light);
        }

        .modal-btn.secondary:hover {
            color: white;
            border-color: white;
        }

        .code-display {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-display span {
            font-size: 18px;
            letter-spacing: 2px;
        }

        .copy-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        .welcome-title {
            font-size: 36px;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-description {
            color: var(--text-light);
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .features {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            flex: 1;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .feature-icon {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .feature-title {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-text {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #5865F2;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4752c4;
        }

        /* Responsive design */
        @media (max-width: 900px) {
            .groups-sidebar {
                width: 70px;
            }
            
            .channels-sidebar {
                width: 200px;
            }
            
            .features {
                flex-direction: column;
            }
        }
        
        /* Participants panel */
        .participants-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 33, 36, 0.9);
            border-radius: 10px;
            padding: 15px;
            max-width: 250px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }
        
        .participants-panel.active {
            display: block;
        }
        
        .participant-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.2);
        }
        
        .participant-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .participant-name {
            flex: 1;
            color: var(--light);
            font-size: 14px;
        }
        
        .participant-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--gray);
        }
        
        .participant-status.talking {
            background-color: var(--success);
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Groups sidebar -->
        <div class="groups-sidebar" id="groups-sidebar">
            <div class="group-icon add" id="add-group">
                <i class="fas fa-plus"></i>
            </div>
            <!-- Groups will be added dynamically -->
        </div>

        <!-- Channels sidebar -->
        <div class="channels-sidebar" id="channels-sidebar">
            <div class="channel-header">
                <span id="group-name">PeerChat</span>
                <i class="fas fa-cog" id="group-settings"></i>
            </div>
            <div class="channel-category">
                <span>VOICE CHANNELS</span>
                <i class="fas fa-plus" id="add-voice-channel"></i>
            </div>
            <div class="channel-list" id="voice-channels">
                <!-- Voice channels will be added here -->
            </div>
            <div class="channel-category">
                <span>TEXT CHANNELS</span>
                <i class="fas fa-plus" id="add-text-channel"></i>
            </div>
            <div class="channel-list" id="text-channels">
                <!-- Text channels will be added here -->
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-area" id="chat-area">
            <div class="welcome-screen" id="welcome-screen">
                <h1 class="welcome-title">Welcome to PeerChat</h1>
                <p class="welcome-description">A peer-to-peer group chat application with voice capabilities</p>
                
                <div class="features">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="feature-title">Create Groups</h3>
                        <p class="feature-text">Create or join chat groups with your friends and colleagues</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="feature-title">Text Chat</h3>
                        <p class="feature-text">Send text messages in real-time with other group members</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h3 class="feature-title">Voice Chat</h3>
                        <p class="feature-text">Join voice channels for live conversations</p>
                    </div>
                </div>
                
                <button class="modal-btn primary" id="start-chatting">Start Chatting</button>
            </div>
            
            <div class="chat-header" style="display: none;" id="active-chat-header">
                <i class="fas fa-hashtag"></i>
                <h2 id="channel-name">general</h2>
            </div>
            <div class="messages-container" id="messages-container" style="display: none;">
                <div class="system-message">Welcome! Create or join a group to start chatting.</div>
                <div class="message">
                    <div class="avatar">PC</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="username">PeerChat</span>
                            <span class="timestamp">Just now</span>
                        </div>
                        <div class="message-text">Click the <span style="color: var(--primary); font-weight: bold;">+ button</span> to create a new group!</div>
                        <div class="message-text">Voice chat shows when users enter/leave channels</div>
                    </div>
                </div>
            </div>
            <div class="input-area" style="display: none;" id="input-area">
                <div class="message-input-container">
                    <input type="text" class="message-input" id="message-input" placeholder="Message #general" disabled>
                    <i class="fas fa-microphone" id="voice-chat-btn"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice controls -->
    <div class="voice-controls" id="voice-controls">
        <div class="voice-btn" id="participants-btn">
            <i class="fas fa-users"></i>
        </div>
        <div class="voice-btn" id="mute-btn">
            <i class="fas fa-microphone"></i>
        </div>
        <div class="voice-btn leave" id="leave-btn">
            <i class="fas fa-phone-slash"></i>
        </div>
    </div>
    
    <!-- Participants panel -->
    <div class="participants-panel" id="participants-panel">
        <div class="participant-header">
            <span>Voice Participants</span>
            <i class="fas fa-times" id="close-participants"></i>
        </div>
        <div id="participants-container">
            <!-- Participants will be added here dynamically -->
        </div>
    </div>

    <!-- Connection status -->
    <div class="connection-status" id="connection-status">
        <span class="status-indicator status-disconnected"></span>
        <span id="status-text">Voice: Disconnected</span>
    </div>

    <!-- Group Creation Modal -->
    <div class="modal" id="group-modal">
        <div class="modal-content">
            <div class="modal-title">Create New Group</div>
            <input type="text" class="modal-input" id="group-name-input" placeholder="Group Name">
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancel-group">Cancel</button>
                <button class="modal-btn primary" id="create-group">Create</button>
            </div>
        </div>
    </div>

    <!-- Join Group Modal -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <div class="modal-title">Join a Group</div>
            <input type="text" class="modal-input" id="group-id-input" placeholder="Group Code">
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancel-join">Cancel</button>
                <button class="modal-btn primary" id="join-group">Join</button>
            </div>
        </div>
    </div>
    
    <!-- Group Action Modal -->
    <div class="modal" id="group-action-modal">
        <div class="modal-content">
            <div class="modal-title">Group Actions</div>
            <div class="modal-buttons" style="flex-direction: column; gap: 15px;">
                <button class="modal-btn primary" id="create-group-action">
                    <i class="fas fa-plus"></i>
                    <span>Create New Group</span>
                </button>
                <button class="modal-btn primary" id="join-group-action">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Join Existing Group</span>
                </button>
                <button class="modal-btn secondary" id="cancel-group-action">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Username Modal -->
    <div class="modal" id="username-modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-title">Set Your Username</div>
            <input type="text" class="modal-input" id="username-input" placeholder="Enter your username">
            <div class="modal-buttons">
                <button class="modal-btn primary" id="save-username">Save</button>
            </div>
        </div>
    </div>

    <script>
        // App state
        const state = {
            username: '',
            currentGroup: null,
            currentChannel: null,
            groups: [],
            channels: [],
            currentVoiceChannel: null,
            isMuted: false,
            groupCodes: {},
            messages: {},
            // PeerJS state
            peer: null,
            myPeerId: null,
            mediaStream: null,
            connections: {},
            callActive: false,
            participants: {},
            connectionStatus: 'disconnected',
            voiceChannelUsers: {}
        };

        // DOM elements
        const elements = {
            groupsSidebar: document.getElementById('groups-sidebar'),
            channelsSidebar: document.getElementById('channels-sidebar'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            voiceControls: document.getElementById('voice-controls'),
            muteBtn: document.getElementById('mute-btn'),
            leaveBtn: document.getElementById('leave-btn'),
            groupModal: document.getElementById('group-modal'),
            groupNameInput: document.getElementById('group-name-input'),
            createGroup: document.getElementById('create-group'),
            cancelGroup: document.getElementById('cancel-group'),
            joinModal: document.getElementById('join-modal'),
            groupIdInput: document.getElementById('group-id-input'),
            joinGroup: document.getElementById('join-group'),
            cancelJoin: document.getElementById('cancel-join'),
            addGroup: document.getElementById('add-group'),
            groupName: document.getElementById('group-name'),
            channelName: document.getElementById('channel-name'),
            voiceChannels: document.getElementById('voice-channels'),
            textChannels: document.getElementById('text-channels'),
            addVoiceChannel: document.getElementById('add-voice-channel'),
            addTextChannel: document.getElementById('add-text-channel'),
            groupSettings: document.getElementById('group-settings'),
            voiceChatBtn: document.getElementById('voice-chat-btn'),
            usernameModal: document.getElementById('username-modal'),
            usernameInput: document.getElementById('username-input'),
            saveUsername: document.getElementById('save-username'),
            participantsPanel: document.getElementById('participants-panel'),
            participantsContainer: document.getElementById('participants-container'),
            closeParticipants: document.getElementById('close-participants'),
            participantsBtn: document.getElementById('participants-btn'),
            connectionStatus: document.getElementById('connection-status'),
            statusText: document.getElementById('status-text'),
            welcomeScreen: document.getElementById('welcome-screen'),
            activeChatHeader: document.getElementById('active-chat-header'),
            inputArea: document.getElementById('input-area'),
            startChatting: document.getElementById('start-chatting'),
            groupActionModal: document.getElementById('group-action-modal'),
            createGroupAction: document.getElementById('create-group-action'),
            joinGroupAction: document.getElementById('join-group-action'),
            cancelGroupAction: document.getElementById('cancel-group-action')
        };

        // Update connection status UI
        function updateConnectionStatus(status, message = '') {
            state.connectionStatus = status;
            const indicator = elements.connectionStatus.querySelector('.status-indicator');
            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('status-connected');
                    elements.statusText.textContent = 'Voice: Connected' + (message ? ' - ' + message : '');
                    break;
                case 'connecting':
                    indicator.classList.add('status-connecting');
                    elements.statusText.textContent = 'Voice: Connecting...' + (message ? ' - ' + message : '');
                    break;
                case 'disconnected':
                    indicator.classList.add('status-disconnected');
                    elements.statusText.textContent = 'Voice: Disconnected' + (message ? ' - ' + message : '');
                    break;
                case 'error':
                    indicator.classList.add('status-disconnected');
                    elements.statusText.textContent = 'Voice: Error' + (message ? ' - ' + message : '');
                    break;
            }
        }

        // Initialize PeerJS
        function initPeerJS() {
            updateConnectionStatus('connecting', 'Initializing voice connection');
            
            // Generate a unique peer ID
            const peerId = `${state.username.replace(/\s+/g, '')}-${Date.now().toString(36).slice(-5)}`;
            
            // Use a reliable public server
            state.peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 3
            });
            
            state.peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                state.myPeerId = id;
                updateConnectionStatus('connected', 'Ready for voice chat');
            });
            
            state.peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                updateConnectionStatus('error', err.message);
                
                // Attempt to reconnect
                setTimeout(() => {
                    if (state.connectionStatus !== 'connected') {
                        initPeerJS();
                    }
                }, 3000);
            });
            
            state.peer.on('disconnected', () => {
                updateConnectionStatus('disconnected', 'Reconnecting...');
                setTimeout(initPeerJS, 2000);
            });
            
            // Handle incoming calls
            state.peer.on('call', (call) => {
                if (!state.callActive || !state.mediaStream) {
                    call.close();
                    return;
                }
                
                call.answer(state.mediaStream);
                
                call.on('stream', (remoteStream) => {
                    handleNewParticipant(call.peer, remoteStream);
                });
                
                call.on('close', () => {
                    removeParticipant(call.peer);
                });
            });
        }
        
        // Handle new participant
        function handleNewParticipant(peerId, stream) {
            if (state.participants[peerId]) return;
            
            // Create an audio element for the remote stream
            const audio = new Audio();
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = 0.8;
            
            // Extract username from peerId
            const username = peerId.split('-')[0];
            
            // Add to participants
            state.participants[peerId] = {
                username: username,
                stream: stream,
                audio: audio,
                talking: false
            };
            
            // Add user to voice channel
            addUserToVoiceChannel(state.currentVoiceChannel.id, username);
            
            // Update UI
            updateParticipantsUI();
            
            // Add system message
            addMessage(`${username} joined the voice channel`, 'system');
        }
        
        // Remove a participant
        function removeParticipant(peerId) {
            if (!state.participants[peerId]) return;
            
            // Get username before removing
            const username = state.participants[peerId].username;
            
            // Clean up
            const tracks = state.participants[peerId].stream.getTracks();
            tracks.forEach(track => track.stop());
            
            if (state.participants[peerId].audio) {
                state.participants[peerId].audio.srcObject = null;
            }
            
            // Remove from state
            delete state.participants[peerId];
            
            // Remove user from voice channel
            removeUserFromVoiceChannel(state.currentVoiceChannel.id, username);
            
            // Update UI
            updateParticipantsUI();
            
            // Add system message
            addMessage(`${username} left the voice channel`, 'system');
        }
        
        // Update participants UI
        function updateParticipantsUI() {
            elements.participantsContainer.innerHTML = '';
            
            // Add self first
            const selfItem = document.createElement('div');
            selfItem.className = 'participant-item';
            selfItem.innerHTML = `
                <div class="participant-avatar">${state.username.substring(0, 2).toUpperCase()}</div>
                <div class="participant-name">${state.username} (You)</div>
                <div class="participant-status ${state.isMuted ? '' : 'talking'}"></div>
            `;
            elements.participantsContainer.appendChild(selfItem);
            
            // Add other participants
            Object.keys(state.participants).forEach(peerId => {
                const participant = state.participants[peerId];
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div class="participant-avatar">${participant.username.substring(0, 2).toUpperCase()}</div>
                    <div class="participant-name">${participant.username}</div>
                    <div class="participant-status talking"></div>
                `;
                elements.participantsContainer.appendChild(item);
            });
        }
        
        // Add user to voice channel
        function addUserToVoiceChannel(channelId, username) {
            if (!state.voiceChannelUsers[channelId]) {
                state.voiceChannelUsers[channelId] = [];
            }
            
            if (!state.voiceChannelUsers[channelId].includes(username)) {
                state.voiceChannelUsers[channelId].push(username);
                updateVoiceChannelUserCount(channelId);
            }
        }
        
        // Remove user from voice channel
        function removeUserFromVoiceChannel(channelId, username) {
            if (state.voiceChannelUsers[channelId]) {
                const index = state.voiceChannelUsers[channelId].indexOf(username);
                if (index !== -1) {
                    state.voiceChannelUsers[channelId].splice(index, 1);
                    updateVoiceChannelUserCount(channelId);
                }
            }
        }
        
        // Update user count in voice channel UI
        function updateVoiceChannelUserCount(channelId) {
            const channelElement = document.querySelector(`.channel[data-id="${channelId}"]`);
            if (channelElement) {
                const userCount = state.voiceChannelUsers[channelId]?.length || 0;
                let countElement = channelElement.querySelector('.user-count');
                
                if (!countElement) {
                    countElement = document.createElement('span');
                    countElement.className = 'user-count';
                    channelElement.appendChild(countElement);
                }
                
                countElement.textContent = userCount;
            }
        }
        
        // Initialize voice chat
        async function initVoiceChat() {
            try {
                // Initialize PeerJS if not already done
                if (!state.peer) {
                    initPeerJS();
                }
                
                // Get the user's microphone
                state.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });
                
                // Enable voice controls
                elements.voiceControls.classList.add('active');
                state.callActive = true;
                
                // Add user to voice channel
                addUserToVoiceChannel(state.currentVoiceChannel.id, state.username);
                
                // Add system message
                addMessage(`${state.username} joined the voice channel`, 'system');
                updateConnectionStatus('connected', 'In voice channel');
                
            } catch (err) {
                console.error('Error accessing microphone:', err);
                updateConnectionStatus('error', 'Microphone access denied');
                addMessage('Failed to access microphone. Please check permissions.', 'system');
            }
        }
        
        // Leave voice chat
        function leaveVoiceChat() {
            // Close all connections
            Object.values(state.connections).forEach(call => {
                call.close();
            });
            state.connections = {};
            
            // Remove all participants
            Object.keys(state.participants).forEach(peerId => {
                removeParticipant(peerId);
            });
            state.participants = {};
            
            // Stop local media stream
            if (state.mediaStream) {
                state.mediaStream.getTracks().forEach(track => track.stop());
                state.mediaStream = null;
            }
            
            // Remove self from voice channel
            removeUserFromVoiceChannel(state.currentVoiceChannel.id, state.username);
            
            // Add system message
            addMessage(`${state.username} left the voice channel`, 'system');
            
            // Hide controls
            elements.voiceControls.classList.remove('active');
            elements.participantsPanel.classList.remove('active');
            state.callActive = false;
            
            updateConnectionStatus('disconnected', 'Voice chat ended');
        }
        
        // Toggle mute
        function toggleMute() {
            if (!state.mediaStream) return;
            
            state.isMuted = !state.isMuted;
            
            // Mute/unmute all audio tracks
            state.mediaStream.getAudioTracks().forEach(track => {
                track.enabled = !state.isMuted;
            });
            
            // Update UI
            elements.muteBtn.classList.toggle('active', state.isMuted);
            elements.muteBtn.innerHTML = state.isMuted ? 
                '<i class="fas fa-microphone-slash"></i>' : 
                '<i class="fas fa-microphone"></i>';
            
            // Add activity message
            const activityElement = document.createElement('div');
            activityElement.className = 'voice-activity';
            activityElement.innerHTML = `
                <i class="fas fa-microphone${state.isMuted ? '-slash' : ''}"></i>
                <span>You ${state.isMuted ? 'muted' : 'unmuted'} your microphone</span>
            `;
            elements.messagesContainer.appendChild(activityElement);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            
            updateParticipantsUI();
        }

        // Generate a random group code
        function generateGroupCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i > 0 && i % 4 === 0) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Save state to localStorage
        function saveState() {
            const stateToSave = {
                groups: state.groups,
                messages: state.messages,
                groupCodes: state.groupCodes,
                username: state.username
            };
            localStorage.setItem('peerChatState', JSON.stringify(stateToSave));
        }

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('peerChatState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.groups = parsed.groups || [];
                state.messages = parsed.messages || {};
                state.groupCodes = parsed.groupCodes || {};
                state.username = parsed.username || '';
            }
        }

        // Initialize message storage for a group
        function initMessageStorage(group) {
            if (!state.messages[group.id]) {
                state.messages[group.id] = {};
                
                // Initialize storage for each channel
                group.textChannels.forEach(channel => {
                    if (!state.messages[group.id][channel.id]) {
                        state.messages[group.id][channel.id] = [];
                    }
                });
            }
        }

        // Create a new group
        function createGroup(name) {
            const groupCode = generateGroupCode();
            const group = {
                id: 'group-' + Date.now(),
                name: name,
                code: groupCode,
                description: 'A new group for chatting and collaboration',
                owner: state.username,
                members: [state.username],
                voiceChannels: [
                    { id: 'voice-1', name: 'General Voice', type: 'voice' }
                ],
                textChannels: [
                    { id: 'text-1', name: 'general', type: 'text' }
                ]
            };
            
            state.groups.push(group);
            state.currentGroup = group;
            state.groupCodes[groupCode] = group;
            
            // Initialize message storage
            initMessageStorage(group);
            
            renderGroups();
            renderChannels();
            
            // Set the first text channel as active
            setActiveChannel(group.textChannels[0]);
            
            addMessage(`Created group: ${name}`, 'system');
            
            // Save state
            saveState();
        }

        // Join an existing group
        function joinGroup(groupCode) {
            // Check if already in this group
            if (state.groups.some(group => group.code === groupCode)) {
                addMessage(`You are already in this group!`, 'system');
                return;
            }
            
            // Check if group exists
            if (!state.groupCodes[groupCode]) {
                addMessage(`Group with code ${groupCode} not found!`, 'system');
                return;
            }
            
            const group = state.groupCodes[groupCode];
            
            // Add user to group
            if (!group.members.includes(state.username)) {
                group.members.push(state.username);
            }
            
            state.groups.push(group);
            state.currentGroup = group;
            
            // Initialize message storage if needed
            initMessageStorage(group);
            
            renderGroups();
            renderChannels();
            setActiveChannel(group.textChannels[0]);
            
            addMessage(`Joined group: ${group.name}`, 'system');
            
            // Save state
            saveState();
        }

        // Render groups in the sidebar
        function renderGroups() {
            elements.groupsSidebar.innerHTML = '';
            
            // Add the create group button first
            const addButton = document.createElement('div');
            addButton.className = 'group-icon add';
            addButton.id = 'add-group';
            addButton.innerHTML = '<i class="fas fa-plus"></i>';
            elements.groupsSidebar.appendChild(addButton);
            
            // Add event listener to the newly created button
            addButton.addEventListener('click', () => {
                elements.groupActionModal.style.display = 'flex';
            });
            
            // Add existing groups
            state.groups.forEach(group => {
                const groupIcon = document.createElement('div');
                groupIcon.className = 'group-icon' + (state.currentGroup?.id === group.id ? ' active' : '');
                groupIcon.innerHTML = group.name.substring(0, 2).toUpperCase();
                groupIcon.title = group.name;
                groupIcon.onclick = () => {
                    state.currentGroup = group;
                    renderGroups();
                    renderChannels();
                    setActiveChannel(group.textChannels[0]);
                };
                elements.groupsSidebar.appendChild(groupIcon);
            });
        }

        // Render channels for the current group
        function renderChannels() {
            if (!state.currentGroup) {
                elements.voiceChannels.innerHTML = '';
                elements.textChannels.innerHTML = '';
                elements.groupName.textContent = 'PeerChat';
                return;
            }
            
            elements.groupName.textContent = state.currentGroup.name;
            
            // Render voice channels
            elements.voiceChannels.innerHTML = '';
            state.currentGroup.voiceChannels.forEach(channel => {
                const channelEl = document.createElement('div');
                channelEl.className = 'channel';
                channelEl.dataset.id = channel.id;
                channelEl.dataset.type = 'voice';
                channelEl.innerHTML = `
                    <i class="fas fa-volume-up"></i>
                    <span>${channel.name}</span>
                    <span class="user-count">${state.voiceChannelUsers[channel.id]?.length || 0}</span>
                `;
                channelEl.onclick = () => {
                    setActiveChannel(channel);
                };
                elements.voiceChannels.appendChild(channelEl);
            });
            
            // Render text channels
            elements.textChannels.innerHTML = '';
            state.currentGroup.textChannels.forEach(channel => {
                const channelEl = document.createElement('div');
                channelEl.className = 'channel' + (state.currentChannel?.id === channel.id ? ' active' : '');
                channelEl.dataset.id = channel.id;
                channelEl.dataset.type = 'text';
                channelEl.innerHTML = `<i class="fas fa-hashtag"></i><span>${channel.name}</span>`;
                channelEl.onclick = () => {
                    setActiveChannel(channel);
                };
                elements.textChannels.appendChild(channelEl);
            });
        }

        // Set active channel
        function setActiveChannel(channel) {
            state.currentChannel = channel;
            elements.channelName.textContent = channel.name;
            elements.messageInput.placeholder = `Message #${channel.name}`;
            
            // Update UI
            document.querySelectorAll('.channel').forEach(el => {
                el.classList.remove('active');
            });
            
            const activeEl = document.querySelector(`.channel[data-id="${channel.id}"]`);
            if (activeEl) {
                activeEl.classList.add('active');
            }
            
            // Clear messages and add welcome message
            elements.messagesContainer.innerHTML = `<div class="system-message">Welcome to #${channel.name}</div>`;
            
            // Enable input for text channels
            elements.messageInput.disabled = channel.type !== 'text';
            
            // If switching to voice channel, join it
            if (channel.type === 'voice') {
                state.currentVoiceChannel = channel;
                initVoiceChat();
            } else if (state.callActive) {
                leaveVoiceChat();
                state.currentVoiceChannel = null;
            }
            
            // Load messages for this channel
            loadChannelMessages();
        }

        // Load messages for the current channel
        function loadChannelMessages() {
            if (!state.currentGroup || !state.currentChannel || 
                state.currentChannel.type !== 'text') return;
            
            const groupId = state.currentGroup.id;
            const channelId = state.currentChannel.id;
            
            // Get messages for this channel
            const messages = state.messages[groupId]?.[channelId] || [];
            
            // Render each message
            messages.forEach(msg => {
                createMessageElement(msg);
            });
            
            // Scroll to bottom
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Create a message element
        function createMessageElement(msg) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const avatarText = msg.username.substring(0, 2).toUpperCase();
            const time = new Date(msg.timestamp);
            const timeString = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (msg.type === 'text') {
                messageElement.innerHTML = `
                    <div class="avatar">${avatarText}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="username">${msg.username}</span>
                            <span class="timestamp">${timeString}</span>
                        </div>
                        <div class="message-text">${msg.content}</div>
                    </div>
                `;
            } else if (msg.type === 'system') {
                messageElement.innerHTML = `<div class="system-message">${msg.content}</div>`;
            }
            
            elements.messagesContainer.appendChild(messageElement);
        }

        // Add a message to the chat
        function addMessage(content, type = 'text', username = state.username) {
            if (!state.currentGroup || !state.currentChannel) return;
            
            const groupId = state.currentGroup.id;
            const channelId = state.currentChannel.id;
            
            // Create message object
            const message = {
                id: 'msg-' + Date.now(),
                type: type,
                content: content,
                username: username,
                timestamp: new Date().toISOString()
            };
            
            // For text channels, save the message
            if (state.currentChannel.type === 'text') {
                // Ensure storage exists
                if (!state.messages[groupId]) state.messages[groupId] = {};
                if (!state.messages[groupId][channelId]) state.messages[groupId][channelId] = [];
                
                // Add message to storage
                state.messages[groupId][channelId].push(message);
                
                // Save state
                saveState();
            }
            
            // Create and append message element
            createMessageElement(message);
            
            // Scroll to bottom
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Initialize the app
        function init() {
            // Load state from localStorage
            loadState();
            
            // Check if username is already set
            const savedUsername = state.username;
            if (savedUsername) {
                elements.usernameModal.style.display = 'none';
            } else {
                // Set a default username
                state.username = "User" + Math.floor(Math.random() * 1000);
                elements.usernameInput.value = state.username;
            }
            
            // Initialize PeerJS
            initPeerJS();
            
            // Event listeners
            elements.saveUsername.addEventListener('click', () => {
                const username = elements.usernameInput.value.trim();
                if (username) {
                    state.username = username;
                    localStorage.setItem('username', username);
                    elements.usernameModal.style.display = 'none';
                    
                    // Save state
                    saveState();
                    
                    // Reinitialize PeerJS with new username
                    initPeerJS();
                }
            });
            
            elements.addGroup.addEventListener('click', () => {
                elements.groupActionModal.style.display = 'flex';
            });
            
            elements.createGroupAction.addEventListener('click', () => {
                elements.groupActionModal.style.display = 'none';
                elements.groupModal.style.display = 'flex';
            });
            
            elements.joinGroupAction.addEventListener('click', () => {
                elements.groupActionModal.style.display = 'none';
                elements.joinModal.style.display = 'flex';
            });
            
            elements.cancelGroupAction.addEventListener('click', () => {
                elements.groupActionModal.style.display = 'none';
            });
            
            elements.cancelGroup.addEventListener('click', () => {
                elements.groupModal.style.display = 'none';
            });
            
            elements.createGroup.addEventListener('click', () => {
                const groupName = elements.groupNameInput.value.trim();
                if (groupName) {
                    createGroup(groupName);
                    elements.groupModal.style.display = 'none';
                    elements.groupNameInput.value = '';
                }
            });
            
            elements.cancelJoin.addEventListener('click', () => {
                elements.joinModal.style.display = 'none';
            });
            
            elements.joinGroup.addEventListener('click', () => {
                const groupCode = elements.groupIdInput.value.trim();
                if (groupCode) {
                    joinGroup(groupCode);
                    elements.joinModal.style.display = 'none';
                }
            });
            
            elements.addVoiceChannel.addEventListener('click', () => {
                if (state.currentGroup) {
                    const channelName = prompt('Enter voice channel name:');
                    if (channelName) {
                        state.currentGroup.voiceChannels.push({
                            id: 'voice-' + Date.now(),
                            name: channelName,
                            type: 'voice'
                        });
                        renderChannels();
                    }
                }
            });
            
            elements.addTextChannel.addEventListener('click', () => {
                if (state.currentGroup) {
                    const channelName = prompt('Enter text channel name:');
                    if (channelName) {
                        const newChannel = {
                            id: 'text-' + Date.now(),
                            name: channelName,
                            type: 'text'
                        };
                        state.currentGroup.textChannels.push(newChannel);
                        renderChannels();
                        
                        // Initialize message storage for new channel
                        if (!state.messages[state.currentGroup.id]) {
                            state.messages[state.currentGroup.id] = {};
                        }
                        state.messages[state.currentGroup.id][newChannel.id] = [];
                        
                        // Save state
                        saveState();
                    }
                }
            });
            
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && elements.messageInput.value.trim()) {
                    const message = elements.messageInput.value.trim();
                    addMessage(message, 'text');
                    elements.messageInput.value = '';
                }
            });
            
            elements.muteBtn.addEventListener('click', toggleMute);
            elements.leaveBtn.addEventListener('click', leaveVoiceChat);
            
            elements.voiceChatBtn.addEventListener('click', () => {
                if (state.currentGroup) {
                    const voiceChannel = state.currentGroup.voiceChannels[0];
                    if (voiceChannel) {
                        setActiveChannel(voiceChannel);
                    }
                }
            });
            
            elements.participantsBtn.addEventListener('click', () => {
                elements.participantsPanel.classList.toggle('active');
            });
            
            elements.closeParticipants.addEventListener('click', () => {
                elements.participantsPanel.classList.remove('active');
            });
            
            elements.startChatting.addEventListener('click', () => {
                elements.welcomeScreen.style.display = 'none';
                elements.activeChatHeader.style.display = 'flex';
                elements.messagesContainer.style.display = 'flex';
                elements.inputArea.style.display = 'block';
            });
            
            // Initial render
            renderGroups();
            renderChannels();
        }

        // Start the app
        init();
    </script>
</body>
</html>